{% extends 'app/base.html' %}
{% load static %}

<!-- Styles -->
{% block styles %}
  <link rel="stylesheet" href="{% static 'forum/styles/post_create.css' %}">
  <style>
    .file-error {
      display: none;
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 0.25rem;
      padding: 0.75rem 1.25rem;
      margin-top: 0.5rem;
    }
    .file-error.show {
      display: block;
    }
    .image-preview-container {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .image-preview {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 4px;
      overflow: hidden;
    }
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
{% endblock %}

<title>{% block title %}Channels | Create Post{% endblock %}</title>

{% block content %}
  <div class="content-container">
    <h2 class="form-title">New Forum Post</h2>
    <form method="post" enctype="multipart/form-data" id="post-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.title.id_for_label }}">Title: </label>
        {{ form.title }}
      </div>

      <div class="form-group">
        <label for="{{ form.caption.id_for_label }}">Caption: </label>
        {{ form.caption }}
      </div>

      <div class="form-group">
        <label for="id_images">Upload Images <span style="color: red;">*</span></label>
        <input type="file" id="id_images" name="images" class="form-control" accept="image/*" multiple>
        <div id="file-error" class="file-error"></div>
        <div id="image-preview-container" class="image-preview-container"></div>
        <small class="form-text text-muted">Accepted formats: JPEG, PNG, GIF, WebP, BMP (Max 5MB each)</small>
      </div>

      <div class="form-group">
        <label for="{{ form.tag.id_for_label }}">Tags: </label>
        {{ form.tag }}
      </div>

      <div class="form-group">
        <label for="{{ form.privacy.id_for_label }}">Privacy: </label>
        {{ form.privacy }}
      </div>
      
      <button type="submit" class="btn btn-primary">Create</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('id_images');
      const fileErrorDiv = document.getElementById('file-error');
      const previewContainer = document.getElementById('image-preview-container');
      const postForm = document.getElementById('post-form');
      
      const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
      const maxSize = 5 * 1024 * 1024; // 5MB per image
      
      imageInput.addEventListener('change', function() {
        fileErrorDiv.classList.remove('show');
        fileErrorDiv.textContent = '';
        previewContainer.innerHTML = '';
        
        if (this.files && this.files.length > 0) {
          let hasError = false;
          
          for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            
            // Check if file is an image
            if (!validImageTypes.includes(file.type)) {
              fileErrorDiv.textContent = `File "${file.name}" is not a valid image (JPEG, PNG, GIF, WebP, or BMP).`;
              fileErrorDiv.classList.add('show');
              hasError = true;
              break;
            }
            
            // Check file size
            if (file.size > maxSize) {
              fileErrorDiv.textContent = `File "${file.name}" is too large (max 5MB per image).`;
              fileErrorDiv.classList.add('show');
              hasError = true;
              break;
            }
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.createElement('div');
              preview.className = 'image-preview';
              preview.innerHTML = `<img src="${e.target.result}" alt="Preview of ${file.name}">`;
              previewContainer.appendChild(preview);
            };
            reader.readAsDataURL(file);
          }
          
          if (hasError) {
            this.value = ''; // Clear the input
            previewContainer.innerHTML = '';
          }
        }
      });
      
      // Prevent form submission if file validation fails
      postForm.addEventListener('submit', function(e) {
        if (fileErrorDiv.classList.contains('show')) {
          e.preventDefault();
        }
      });
    });
  </script>
{% endblock %}
